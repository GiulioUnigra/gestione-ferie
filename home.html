<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Home - Gestione Ferie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fdf9;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .profilo-card {
      background: #f3fdf3;
      border: 1px solid #ccc;
      border-radius: 20px;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .profilo-icona {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      margin-right: 20px;
      cursor: pointer;
    }
    .profilo-info {
      text-align: left;
    }
    .moduli {
      text-align: center;
      margin: 20px 0;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 1000px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #d2f5d2;
    }
    .hidden {
      display: none;
    }
    .gruppo-header {
      background-color: #eef8ee;
      font-weight: bold;
    }
    .referente-row {
      background-color: #f0fcf0;
      font-style: italic;
    }
    #uploadFoto {
      display: none;
    }
  </style>
</head>
<body>
  <h2>üè† Benvenuto in Gestione Ferie</h2>
  <div id="profilo_personale"></div>
  <input type="file" id="uploadFoto" accept="image/*">
  <div class="moduli" id="bottoni_moduli"></div>
  <button id="mostra_tabella" class="hidden">üë• Visualizza Dipendenti</button>
  <div id="tabella_dipendenti" class="hidden"></div>
  <button id="torna_profilo" class="hidden">‚¨Ö Torna al tuo profilo</button>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://sauahmyekejigpbjrdug.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhdWFobXlla2VqaWdwYmpyZHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0Njc2OTcsImV4cCI6MjA2NzA0MzY5N30.JetFvFBwg1dy9AqyeSnTYalAuuIrPAyaFWzc8SRaxYo'
    );

    const utente = JSON.parse(localStorage.getItem("utenteLoggato"));
    const idUtente = utente.id;
    const ruolo = utente.ruolo;
    const gruppiGestiti = Array.isArray(utente.gruppi_gestiti) ? utente.gruppi_gestiti : (utente.gruppi_gestiti || "").split(",").map(g => g.trim());

    const oggi = new Date();
    if (oggi.getMonth() === 0 && oggi.getDate() === 1) aggiornaMonteOreAnnuale();

    async function aggiornaMonteOreAnnuale() {
      const { data } = await supabase.from("dipendenti").select("id, ore_disponibili, ore_annuali");
      for (const d of data) {
        const nuovoResiduo = d.ore_disponibili + d.ore_annuali;
        await supabase.from("dipendenti").update({ ore_disponibili: nuovoResiduo }).eq("id", d.id);
      }
    }

    async function caricaProfilo() {
      const { data } = await supabase.from("dipendenti").select("nome, ruolo, gruppo, ore_disponibili, ore_fruite, foto_profilo").eq("id", idUtente).single();
      const foto = data.foto_profilo || "https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Sample_User_Icon.png/480px-Sample_User_Icon.png";

      document.getElementById("profilo_personale").innerHTML = `
        <div class="profilo-card">
          <div class="profilo-icona" style="background-image: url('${foto}')" onclick="document.getElementById('uploadFoto').click()"></div>
          <div class="profilo-info">
            <div>üë§ <strong>Nome:</strong> ${data.nome}</div>
            <div>üõ°Ô∏è <strong>Ruolo:</strong> ${data.ruolo}</div>
            <div>üë• <strong>Gruppo:</strong> ${data.gruppo}</div>
            <div>üìä <strong>Ore residue:</strong> ${data.ore_disponibili}</div>
            <div>üìâ <strong>Ore fruite:</strong> ${data.ore_fruite}</div>
          </div>
        </div>`;
    }

    async function uploadFoto() {
      const input = document.getElementById("uploadFoto");
      const file = input.files[0];
      if (!file) return;
      const { data, error } = await supabase.storage.from("profili").upload(`foto/${idUtente}`, file, { upsert: true });
      if (!error) {
        const url = supabase.storage.from("profili").getPublicUrl(`foto/${idUtente}`).data.publicUrl;
        await supabase.from("dipendenti").update({ foto_profilo: url }).eq("id", idUtente);
        caricaProfilo();
      }
    }

    document.getElementById("uploadFoto").addEventListener("change", uploadFoto);

    function creaBottoni() {
      const moduli = [];
      if (["Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üßë‚Äçüíº", "Gestione Dipendenti", "gestione-dipendenti.html"]);
      }
      if (["Analista", "Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üì©", "Richiesta Ferie", "richiesta-ferie.html"]);
        moduli.push(["üìí", "Appunti", "appunti.html"]);
        moduli.push(["üìÖ", "Calendario", "calendario.html"]);
        moduli.push(["üìá", "Rubrica", "rubrica.html"]);
      }
      if (["Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["‚úÖ", "Approvazione Ferie", "approvazione.html"]);
        moduli.push(["‚öôÔ∏è", "Gestione Turni", "gestione-turni.html"]);
      }
      if (["Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üì¶", "Archiviazione", "archiviazione.html"]);
      }
      moduli.push(["üîì", "Logout", "logout.html"]);

      document.getElementById("bottoni_moduli").innerHTML = moduli.map(
        ([icon, label, link]) => `<button onclick="window.location.href='${link}'">${icon} ${label}</button>`
      ).join("");
    }

    document.getElementById("mostra_tabella").onclick = () => {
      document.getElementById("profilo_personale").classList.add("hidden");
      document.getElementById("bottoni_moduli").classList.add("hidden");
      document.getElementById("mostra_tabella").classList.add("hidden");
      document.getElementById("tabella_dipendenti").classList.remove("hidden");
      document.getElementById("torna_profilo").classList.remove("hidden");
    };

    document.getElementById("torna_profilo").onclick = () => {
      document.getElementById("profilo_personale").classList.remove("hidden");
      document.getElementById("bottoni_moduli").classList.remove("hidden");
      document.getElementById("mostra_tabella").classList.remove("hidden");
      document.getElementById("tabella_dipendenti").classList.add("hidden");
      document.getElementById("torna_profilo").classList.add("hidden");
    };

    caricaProfilo();
    creaBottoni();
  </script>
</body>
</html>
