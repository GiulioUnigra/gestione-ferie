<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Home - Gestione Ferie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fdf9;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .profilo-card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .profilo-card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
    }
    .profilo-info {
      text-align: left;
    }
    .moduli {
      text-align: center;
      margin: 20px 0;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 1000px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #d2f5d2;
    }
    .hidden {
      display: none;
    }
    .gruppo-header {
      background-color: #eef8ee;
      font-weight: bold;
    }
    .referente-row {
      background-color: #f0fcf0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h2>üè† Benvenuto in Gestione Ferie</h2>
  <div id="profilo_personale"></div>
  <input type="file" id="uploadFoto" accept="image/*">
  <div class="moduli" id="bottoni_moduli"></div>
  <button id="mostra_tabella" class="hidden">üë• Visualizza Dipendenti</button>
  <div id="tabella_dipendenti" class="hidden"></div>
  <button id="torna_profilo" class="hidden">‚¨Ö Torna al tuo profilo</button>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://sauahmyekejigpbjrdug.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhdWFobXlla2VqaWdwYmpyZHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0Njc2OTcsImV4cCI6MjA2NzA0MzY5N30.JetFvFBwg1dy9AqyeSnTYalAuuIrPAyaFWzc8SRaxYo'
    );

    const utente = JSON.parse(localStorage.getItem("utenteLoggato"));
    const ruolo = utente.ruolo;
    const idUtente = utente.id;
    const gruppiGestiti = Array.isArray(utente.gruppi_gestiti) ? utente.gruppi_gestiti : (utente.gruppi_gestiti || "").split(",").map(g => g.trim());

    document.getElementById("mostra_tabella").classList.toggle("hidden", ruolo === "Analista");

    async function caricaProfilo() {
      const { data } = await supabase.from("dipendenti").select("*").eq("id", idUtente).single();
      const { data: ferie } = await supabase.from("ferie").select("inizio, ore").eq("dipendente_id", idUtente).eq("stato", "Approvata");
      const perMese = {};
      ferie.forEach(f => {
        const mese = new Date(f.inizio).toLocaleString('it-IT', { month: 'long' });
        perMese[mese] = (perMese[mese] || 0) + f.ore;
      });
      const tooltip = Object.entries(perMese).map(([m, v]) => `${m}: ${v}h`).join('\n');
      const foto = data.foto || 'https://via.placeholder.com/80';

      document.getElementById("profilo_personale").innerHTML = `
        <div class="profilo-card" title="${tooltip}">
          <img src="${foto}" alt="Foto profilo">
          <div class="profilo-info">
            <div><strong>${data.nome}</strong></div>
            <div>Gruppo: ${data.gruppo}</div>
            <div>Turno: ${data.tipo_turno}</div>
            <div>Ore disponibili: ${data.ore_disponibili || '-'}</div>
          </div>
        </div>`;
    }

    async function caricaDipendenti() {
      const { data: dipendenti } = await supabase.from("dipendenti").select("*").eq("attivo", true);
      const { data: ferie } = await supabase.from("ferie").select("dipendente_id, inizio, ore").eq("stato", "Approvata");

      const ferieMappa = {};
      ferie.forEach(f => {
        const mese = new Date(f.inizio).toLocaleString('it-IT', { month: 'long' });
        ferieMappa[f.dipendente_id] = ferieMappa[f.dipendente_id] || {};
        ferieMappa[f.dipendente_id][mese] = (ferieMappa[f.dipendente_id][mese] || 0) + f.ore;
      });

      const gruppi = ["Infoclienti", "Oli", "Contaminanti", "Microbiologia", "Allergeni", "Confezionati", "Materie Prime", "Cioccolato"];

      let html = `<table><thead><tr><th>Nome</th><th>Gruppo</th><th>Tipo Turno</th><th>Ore Disponibili</th></tr></thead><tbody>`;

      gruppi.forEach(gr => {
        html += `<tr class='gruppo-header'><td colspan="4">${gr}</td></tr>`;
        const referenti = dipendenti.filter(d => d.ruolo === "Referente" && d.gruppi_gestiti?.includes(gr));
        referenti.forEach(ref => {
          html += `<tr class='referente-row'><td colspan="4">Referente: ${ref.nome}</td></tr>`;
          dipendenti.filter(d => d.gruppo === gr && d.ruolo === "Analista").forEach(d => {
            const ferieTooltip = ferieMappa[d.id]
              ? Object.entries(ferieMappa[d.id]).map(([m, v]) => `${m}: ${v}h`).join('\n')
              : '';
            html += `<tr title="${ferieTooltip}"><td>${d.nome}</td><td>${d.gruppo}</td><td>${d.tipo_turno}</td><td>${d.ore_disponibili || '-'}</td></tr>`;
          });
        });
      });

      html += "</tbody></table>";
      document.getElementById("tabella_dipendenti").innerHTML = html;
    }

    document.getElementById("uploadFoto").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const { data, error } = await supabase.storage.from("profili").upload(`foto/${idUtente}`, file, { upsert: true });
      if (!error) {
        const url = supabase.storage.from("profili").getPublicUrl(`foto/${idUtente}`).data.publicUrl;
        await supabase.from("dipendenti").update({ foto: url }).eq("id", idUtente);
        caricaProfilo();
      }
    });

    function creaBottoni() {
      const moduli = [];
      if (["Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üßë‚Äçüíº", "Gestione Dipendenti", "gestione-dipendenti.html"]);
      }
      if (["Analista", "Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üì©", "Richiesta Ferie", "richiesta-ferie.html"]);
        moduli.push(["üìí", "Appunti", "appunti.html"]);
        moduli.push(["üìÖ", "Calendario", "calendario.html"]);
        moduli.push(["üìá", "Rubrica", "rubrica.html"]);
      }
      if (["Referente", "Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["‚úÖ", "Approvazione Ferie", "approvazione.html"]);
        moduli.push(["‚öôÔ∏è", "Gestione Turni", "gestione-turni.html"]);
      }
      if (["Responsabile", "Viceresponsabile"].includes(ruolo)) {
        moduli.push(["üì¶", "Archiviazione", "archiviazione.html"]);
      }
      moduli.push(["üîì", "Logout", "logout.html"]);
      document.getElementById("bottoni_moduli").innerHTML = moduli.map(
        ([icon, label, link]) => `<button onclick="window.location.href='${link}'">${icon} ${label}</button>`
      ).join("");
    }

    document.getElementById("mostra_tabella").onclick = () => {
      document.getElementById("profilo_personale").classList.add("hidden");
      document.getElementById("bottoni_moduli").classList.add("hidden");
      document.getElementById("mostra_tabella").classList.add("hidden");
      document.getElementById("tabella_dipendenti").classList.remove("hidden");
      document.getElementById("torna_profilo").classList.remove("hidden");
      caricaDipendenti();
    };

    document.getElementById("torna_profilo").onclick = () => {
      document.getElementById("profilo_personale").classList.remove("hidden");
      document.getElementById("bottoni_moduli").classList.remove("hidden");
      document.getElementById("mostra_tabella").classList.remove("hidden");
      document.getElementById("tabella_dipendenti").classList.add("hidden");
      document.getElementById("torna_profilo").classList.add("hidden");
    };

    caricaProfilo();
    creaBottoni();
  </script>
</body>
</html>
